// =============================================================================
// Ana's Dashboard Template
// Data tells stories. Dashboards should make them impossible to ignore.
// =============================================================================

import React, { useState, useMemo } from 'react';
import {
  KPICard,
  MetricRow,
  ChartWrapper,
  DataTable,
  DateRangePicker,
  TrendBadge,
  type DateRange,
} from './chart-components';

// =============================================================================
// DASHBOARD CONFIGURATION
// =============================================================================

/**
 * Dashboard Configuration
 * Customize these values for your specific dashboard
 */
const DASHBOARD_CONFIG = {
  title: '{{DASHBOARD_TITLE}}',
  subtitle: '{{DASHBOARD_SUBTITLE}}',
  refreshInterval: 300000, // 5 minutes
  
  // Date range options
  defaultDateRange: 'last_30_days',
  
  // API endpoints
  endpoints: {
    kpis: '/api/analytics/kpis',
    timeSeries: '/api/analytics/time-series',
    breakdown: '/api/analytics/breakdown',
    table: '/api/analytics/table',
  },
};

// =============================================================================
// TYPES
// =============================================================================

interface DashboardData {
  kpis: {
    metric1: { value: number; change: number };
    metric2: { value: number; change: number };
    metric3: { value: number; change: number };
    metric4: { value: number; change: number };
  };
  timeSeries: Array<{ date: string; value: number }>;
  breakdown: Array<{ category: string; value: number; percentage: number }>;
  tableData: Array<Record<string, unknown>>;
}

// =============================================================================
// DATA HOOKS
// =============================================================================

/**
 * Hook to fetch dashboard data
 * Replace with your actual data fetching logic
 */
function useDashboardData(dateRange: DateRange) {
  const [data, setData] = useState<DashboardData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  // In real implementation, fetch from API
  React.useEffect(() => {
    async function fetchData() {
      setLoading(true);
      setError(null);
      
      try {
        // Replace with actual API calls
        // const response = await fetch(DASHBOARD_CONFIG.endpoints.kpis);
        // const data = await response.json();
        
        // Mock data for template
        await new Promise(resolve => setTimeout(resolve, 500));
        
        setData({
          kpis: {
            metric1: { value: 125000, change: 12 },
            metric2: { value: 2450, change: -5 },
            metric3: { value: 89.5, change: 0.2 },
            metric4: { value: 4.2, change: 0.3 },
          },
          timeSeries: generateMockTimeSeries(dateRange),
          breakdown: [
            { category: 'Category A', value: 45000, percentage: 36 },
            { category: 'Category B', value: 35000, percentage: 28 },
            { category: 'Category C', value: 25000, percentage: 20 },
            { category: 'Category D', value: 20000, percentage: 16 },
          ],
          tableData: [
            { name: 'Item 1', value: 12500, change: 15, status: 'active' },
            { name: 'Item 2', value: 8900, change: -3, status: 'active' },
            { name: 'Item 3', value: 7200, change: 8, status: 'active' },
            { name: 'Item 4', value: 5100, change: 0, status: 'inactive' },
          ],
        });
      } catch (err) {
        setError(err instanceof Error ? err : new Error('Failed to fetch data'));
      } finally {
        setLoading(false);
      }
    }

    fetchData();
    
    // Set up refresh interval
    const interval = setInterval(fetchData, DASHBOARD_CONFIG.refreshInterval);
    return () => clearInterval(interval);
  }, [dateRange]);

  return { data, loading, error, refetch: () => {} };
}

// Helper to generate mock time series data
function generateMockTimeSeries(dateRange: DateRange) {
  const days = Math.ceil(
    (dateRange.end.getTime() - dateRange.start.getTime()) / (1000 * 60 * 60 * 24)
  );
  
  return Array.from({ length: days }, (_, i) => {
    const date = new Date(dateRange.start);
    date.setDate(date.getDate() + i);
    return {
      date: date.toISOString().split('T')[0],
      value: Math.floor(Math.random() * 5000) + 3000,
    };
  });
}

// =============================================================================
// DASHBOARD COMPONENT
// =============================================================================

export function Dashboard() {
  // State
  const [dateRange, setDateRange] = useState<DateRange>({
    start: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000),
    end: new Date(),
  });

  // Fetch data
  const { data, loading, error } = useDashboardData(dateRange);

  // Format last updated time
  const lastUpdated = useMemo(() => {
    return new Date().toLocaleTimeString('en-US', {
      hour: 'numeric',
      minute: '2-digit',
    });
  }, [data]);

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white border-b border-gray-200 px-6 py-4">
        <div className="flex justify-between items-center">
          <div>
            <h1 className="text-2xl font-bold text-gray-900">
              {DASHBOARD_CONFIG.title}
            </h1>
            <p className="text-sm text-gray-500">
              {DASHBOARD_CONFIG.subtitle}
            </p>
          </div>
          
          <div className="flex items-center gap-4">
            <span className="text-sm text-gray-500">
              Last updated: {lastUpdated}
            </span>
            <DateRangePicker value={dateRange} onChange={setDateRange} />
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="p-6">
        {error ? (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
            Failed to load dashboard: {error.message}
          </div>
        ) : (
          <div className="space-y-6">
            {/* KPI Row */}
            <section>
              <MetricRow
                metrics={[
                  {
                    title: 'Total Revenue',
                    value: data?.kpis.metric1.value ?? 0,
                    format: 'currency',
                    trend: data ? {
                      value: data.kpis.metric1.change,
                      direction: data.kpis.metric1.change > 0 ? 'up' : 'down',
                      isPositive: data.kpis.metric1.change > 0,
                    } : undefined,
                    comparison: { label: 'vs last period', value: '$111,607' },
                    status: 'good',
                    loading,
                  },
                  {
                    title: 'Active Users',
                    value: data?.kpis.metric2.value ?? 0,
                    format: 'number',
                    trend: data ? {
                      value: Math.abs(data.kpis.metric2.change),
                      direction: data.kpis.metric2.change > 0 ? 'up' : 'down',
                      isPositive: data.kpis.metric2.change > 0,
                    } : undefined,
                    status: data?.kpis.metric2.change < 0 ? 'warning' : 'good',
                    loading,
                  },
                  {
                    title: 'Success Rate',
                    value: data?.kpis.metric3.value ?? 0,
                    format: 'percent',
                    trend: data ? {
                      value: data.kpis.metric3.change,
                      direction: 'up',
                      isPositive: true,
                    } : undefined,
                    status: 'good',
                    loading,
                  },
                  {
                    title: 'Avg. Rating',
                    value: data?.kpis.metric4.value ?? 0,
                    format: 'number',
                    trend: data ? {
                      value: data.kpis.metric4.change,
                      direction: 'up',
                      isPositive: true,
                    } : undefined,
                    status: 'good',
                    loading,
                  },
                ]}
              />
            </section>

            {/* Charts Row */}
            <section className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Main Chart - 2 columns */}
              <div className="lg:col-span-2">
                <ChartWrapper
                  title="Trend Over Time"
                  subtitle="Daily values for selected period"
                  loading={loading}
                >
                  <div className="h-64 flex items-center justify-center text-gray-500">
                    {/* Replace with your chart library (Recharts, Chart.js, etc.) */}
                    <p>ðŸ“ˆ Line Chart: {data?.timeSeries.length ?? 0} data points</p>
                    {/* 
                    <ResponsiveContainer>
                      <LineChart data={data?.timeSeries}>
                        <XAxis dataKey="date" />
                        <YAxis />
                        <Tooltip />
                        <Line type="monotone" dataKey="value" stroke="#3B82F6" />
                      </LineChart>
                    </ResponsiveContainer>
                    */}
                  </div>
                </ChartWrapper>
              </div>

              {/* Breakdown Chart - 1 column */}
              <div>
                <ChartWrapper
                  title="Breakdown by Category"
                  loading={loading}
                >
                  <div className="space-y-3">
                    {data?.breakdown.map((item) => (
                      <div key={item.category}>
                        <div className="flex justify-between text-sm mb-1">
                          <span className="text-gray-600">{item.category}</span>
                          <span className="font-medium">
                            ${item.value.toLocaleString()} ({item.percentage}%)
                          </span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div
                            className="bg-blue-500 h-2 rounded-full"
                            style={{ width: `${item.percentage}%` }}
                          />
                        </div>
                      </div>
                    ))}
                  </div>
                </ChartWrapper>
              </div>
            </section>

            {/* Table Section */}
            <section>
              <ChartWrapper
                title="Detailed Data"
                subtitle="Click a row for more details"
                loading={loading}
                actions={
                  <button className="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">
                    Export CSV
                  </button>
                }
              >
                <DataTable
                  data={data?.tableData ?? []}
                  columns={[
                    { key: 'name', header: 'Name' },
                    {
                      key: 'value',
                      header: 'Value',
                      align: 'right',
                      format: (value) => `$${Number(value).toLocaleString()}`,
                    },
                    {
                      key: 'change',
                      header: 'Change',
                      align: 'right',
                      format: (value) => (
                        <TrendBadge value={Number(value)} format="percent" />
                      ),
                    },
                    {
                      key: 'status',
                      header: 'Status',
                      format: (value) => (
                        <span
                          className={`px-2 py-1 rounded text-xs font-medium ${
                            value === 'active'
                              ? 'bg-green-100 text-green-700'
                              : 'bg-gray-100 text-gray-700'
                          }`}
                        >
                          {String(value)}
                        </span>
                      ),
                    },
                  ]}
                  onRowClick={(row) => console.log('Clicked:', row)}
                  loading={loading}
                />
              </ChartWrapper>
            </section>
          </div>
        )}
      </main>
    </div>
  );
}

// =============================================================================
// EXPORT
// =============================================================================

export default Dashboard;
