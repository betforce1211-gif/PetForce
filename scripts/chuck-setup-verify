#!/usr/bin/env bash
# Chuck Setup Verification
# Verifies automated push workflow is properly installed

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# Icons
CHECK="✓"
CROSS="✗"
WARNING="⚠"
INFO="ℹ"

success() {
    echo -e "${GREEN}${CHECK} $1${NC}"
}

error() {
    echo -e "${RED}${CROSS} $1${NC}"
}

warning() {
    echo -e "${YELLOW}${WARNING} $1${NC}"
}

info() {
    echo -e "${BLUE}${INFO} $1${NC}"
}

header() {
    echo ""
    echo -e "${PURPLE}╔════════════════════════════════════════════════════╗${NC}"
    echo -e "${PURPLE}║  Chuck Setup Verification                          ║${NC}"
    echo -e "${PURPLE}╚════════════════════════════════════════════════════╝${NC}"
    echo ""
}

header

# Check Git
info "Checking Git installation..."
if command -v git &> /dev/null; then
    GIT_VERSION=$(git --version | cut -d' ' -f3)
    success "Git installed: v$GIT_VERSION"
else
    error "Git not found"
    exit 1
fi

# Check Node.js
info "Checking Node.js installation..."
if command -v node &> /dev/null; then
    NODE_VERSION=$(node --version)
    success "Node.js installed: $NODE_VERSION"
else
    error "Node.js not found"
    exit 1
fi

# Check npm
info "Checking npm installation..."
if command -v npm &> /dev/null; then
    NPM_VERSION=$(npm --version)
    success "npm installed: v$NPM_VERSION"
else
    error "npm not found"
    exit 1
fi

# Check GitHub CLI
info "Checking GitHub CLI..."
if command -v gh &> /dev/null; then
    GH_VERSION=$(gh --version | head -n1 | cut -d' ' -f3)
    success "GitHub CLI installed: v$GH_VERSION"
    
    # Check authentication
    if gh auth status &> /dev/null; then
        success "GitHub CLI authenticated"
    else
        warning "GitHub CLI not authenticated"
        info "Run: gh auth login"
    fi
else
    warning "GitHub CLI not found"
    info "Install: brew install gh"
    info "This is optional but required for auto-PR creation"
fi

# Check script files
echo ""
info "Checking Chuck scripts..."

if [ -f "scripts/chuck" ] && [ -x "scripts/chuck" ]; then
    success "Chuck CLI found: scripts/chuck"
else
    error "Chuck CLI not found or not executable"
fi

if [ -f "scripts/chuck-push" ] && [ -x "scripts/chuck-push" ]; then
    success "Chuck Push script found: scripts/chuck-push"
else
    error "Chuck Push script not found or not executable"
fi

# Check configuration
echo ""
info "Checking configuration files..."

if [ -f ".chuckrc.yml" ]; then
    success "Configuration found: .chuckrc.yml"
else
    warning "Configuration not found: .chuckrc.yml"
fi

if [ -f "commitlint.config.js" ]; then
    success "Commitlint config found"
else
    warning "Commitlint config not found"
fi

if [ -f ".github/CODEOWNERS" ]; then
    success "CODEOWNERS found"
else
    warning "CODEOWNERS not found"
fi

# Check GitHub Actions workflows
echo ""
info "Checking GitHub Actions workflows..."

if [ -f ".github/workflows/chuck-push-validation.yml" ]; then
    success "Chuck validation workflow found"
else
    warning "Chuck validation workflow not found"
fi

if [ -f ".github/workflows/ci.yml" ]; then
    success "CI workflow found"
else
    warning "CI workflow not found"
fi

# Check documentation
echo ""
info "Checking documentation..."

if [ -f "CHUCK_AUTOMATION.md" ]; then
    success "Main documentation found"
else
    warning "CHUCK_AUTOMATION.md not found"
fi

if [ -f "docs/workflows/CHUCK_PUSH_WORKFLOW.md" ]; then
    success "Detailed workflow docs found"
else
    warning "Detailed docs not found"
fi

if [ -f "docs/workflows/CHUCK_QUICK_REFERENCE.md" ]; then
    success "Quick reference found"
else
    warning "Quick reference not found"
fi

# Check package.json scripts
echo ""
info "Checking npm scripts..."

if grep -q "chuck:push" package.json; then
    success "npm run chuck:push available"
else
    error "chuck:push script not in package.json"
fi

# Check branch
echo ""
info "Checking current branch..."
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
info "Current branch: $CURRENT_BRANCH"

if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "develop" ]; then
    warning "Currently on protected branch: $CURRENT_BRANCH"
    info "Create a feature branch to test: ./scripts/chuck create-branch feature TEST-001 \"test-workflow\""
fi

# Test validation
echo ""
info "Testing branch validation..."
if ./scripts/chuck validate-branch &> /dev/null; then
    success "Branch validation working"
else
    if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "develop" ]; then
        info "Expected: main/develop don't follow feature branch pattern"
    else
        warning "Branch validation returned non-zero"
    fi
fi

# Summary
echo ""
echo -e "${PURPLE}╔════════════════════════════════════════════════════╗${NC}"
echo -e "${PURPLE}║  Verification Complete                             ║${NC}"
echo -e "${PURPLE}╚════════════════════════════════════════════════════╝${NC}"
echo ""

echo -e "${GREEN}Chuck Automated Push Workflow is installed!${NC}"
echo ""
echo "Next steps:"
echo "  1. Install GitHub CLI: brew install gh"
echo "  2. Authenticate: gh auth login"
echo "  3. Create test branch: ./scripts/chuck create-branch feature TEST-001 \"test-push\""
echo "  4. Make changes and test: npm run chuck:push"
echo ""
echo "Documentation:"
echo "  - Quick Start: CHUCK_AUTOMATION.md"
echo "  - Full Guide: docs/workflows/CHUCK_PUSH_WORKFLOW.md"
echo "  - Quick Ref: docs/workflows/CHUCK_QUICK_REFERENCE.md"
echo ""
echo -e "${BLUE}Quality gates protect pet families. Every deployment matters.${NC}"
echo ""
