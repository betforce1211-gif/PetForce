# .github/workflows/thomas-docs.yml
# Thomas's Documentation Quality Pipeline

name: Thomas Documentation Guardian

on:
  push:
    paths:
      - 'docs/**'
      - '*.md'
      - '.thomas.yml'
  pull_request:
    paths:
      - 'docs/**'
      - '*.md'
      - '.thomas.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================
  # DOCUMENTATION STRUCTURE CHECK
  # ============================================
  structure-check:
    name: üìÅ Structure Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Required Directories
        run: |
          echo "üìÅ Checking documentation structure..."
          
          REQUIRED_DIRS=(
            "docs"
            "docs/getting-started"
            "docs/guides"
            "docs/reference"
            "docs/troubleshooting"
          )
          
          MISSING=()
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              MISSING+=("$dir")
            fi
          done
          
          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è Missing recommended directories:"
            for dir in "${MISSING[@]}"; do
              echo "  - $dir"
            done
            # Warning only, not failing
          else
            echo "‚úÖ All required directories present"
          fi

      - name: Check Required Files
        run: |
          echo "üìÑ Checking required documentation files..."
          
          REQUIRED_FILES=(
            "README.md"
            "docs/getting-started/introduction.md"
          )
          
          MISSING=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING+=("$file")
            fi
          done
          
          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è Missing recommended files:"
            for file in "${MISSING[@]}"; do
              echo "  - $file"
            done
          else
            echo "‚úÖ All required files present"
          fi

  # ============================================
  # MARKDOWN LINTING
  # ============================================
  markdown-lint:
    name: üìù Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD024": {
              "siblings_only": true
            },
            "MD036": false
          }
          EOF

      - name: Run markdownlint
        run: |
          echo "üìù Linting markdown files..."
          markdownlint 'docs/**/*.md' '*.md' --ignore node_modules || true
          echo "‚úÖ Markdown lint complete"

  # ============================================
  # STYLE GUIDE COMPLIANCE
  # ============================================
  style-check:
    name: üé® Style Guide
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Forbidden Phrases
        run: |
          echo "üîç Checking for forbidden phrases..."
          
          FORBIDDEN_PHRASES=(
            "simply"
            "obviously"
            "of course"
            "it's easy"
            "just do"
            "utilize"
            "leverage"
            "in order to"
          )
          
          ISSUES=0
          
          for phrase in "${FORBIDDEN_PHRASES[@]}"; do
            MATCHES=$(grep -ri "$phrase" docs/ --include="*.md" 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              echo ""
              echo "‚ö†Ô∏è Found '$phrase':"
              echo "$MATCHES" | head -5
              ISSUES=$((ISSUES + 1))
            fi
          done
          
          if [ "$ISSUES" -gt 0 ]; then
            echo ""
            echo "‚ùå Found $ISSUES forbidden phrase types"
            echo "See style guide for alternatives"
            # Warning only
          else
            echo "‚úÖ No forbidden phrases found"
          fi

      - name: Check Heading Style
        run: |
          echo "üìë Checking heading consistency..."
          
          # Check for proper heading hierarchy
          find docs/ -name "*.md" | while read file; do
            # Check if H1 exists
            H1_COUNT=$(grep -c "^# " "$file" 2>/dev/null || echo "0")
            
            if [ "$H1_COUNT" -eq 0 ]; then
              echo "‚ö†Ô∏è Missing H1: $file"
            elif [ "$H1_COUNT" -gt 1 ]; then
              echo "‚ö†Ô∏è Multiple H1s: $file"
            fi
            
            # Check for heading jumps (H1 -> H3)
            if grep -q "^# " "$file" && grep -q "^### " "$file"; then
              if ! grep -q "^## " "$file"; then
                echo "‚ö†Ô∏è Heading level skip (H1 -> H3): $file"
              fi
            fi
          done
          
          echo "‚úÖ Heading check complete"

  # ============================================
  # LINK VALIDATION
  # ============================================
  link-check:
    name: üîó Link Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install link checker
        run: npm install -g markdown-link-check

      - name: Create link check config
        run: |
          cat > .markdown-link-check.json << 'EOF'
          {
            "ignorePatterns": [
              {
                "pattern": "^https://localhost"
              },
              {
                "pattern": "^https://127.0.0.1"
              },
              {
                "pattern": "^https://example.com"
              },
              {
                "pattern": "^#"
              }
            ],
            "timeout": "10s",
            "retryOn429": true,
            "retryCount": 3,
            "aliveStatusCodes": [200, 206, 301, 302, 307, 308]
          }
          EOF

      - name: Check Internal Links
        run: |
          echo "üîó Checking internal documentation links..."
          
          find docs/ -name "*.md" | while read file; do
            # Extract relative links
            grep -oE '\]\([^http][^)]+\)' "$file" 2>/dev/null | while read link; do
              # Remove ]( and )
              TARGET=$(echo "$link" | sed 's/\](\(.*\))/\1/' | cut -d'#' -f1)
              
              if [ -n "$TARGET" ]; then
                # Resolve relative path
                DIR=$(dirname "$file")
                FULL_PATH="$DIR/$TARGET"
                
                if [ ! -f "$FULL_PATH" ] && [ ! -d "$FULL_PATH" ]; then
                  echo "‚ö†Ô∏è Broken link in $file: $TARGET"
                fi
              fi
            done
          done
          
          echo "‚úÖ Internal link check complete"

      - name: Check External Links
        continue-on-error: true
        run: |
          echo "üåê Checking external links..."
          find docs/ -name "*.md" -exec markdown-link-check {} -c .markdown-link-check.json \; || true
          echo "‚úÖ External link check complete"

  # ============================================
  # CONTENT QUALITY
  # ============================================
  content-quality:
    name: üìä Content Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Document Length
        run: |
          echo "üìè Checking document lengths..."
          
          find docs/ -name "*.md" | while read file; do
            LINES=$(wc -l < "$file")
            WORDS=$(wc -w < "$file")
            
            if [ "$WORDS" -lt 50 ]; then
              echo "‚ö†Ô∏è Very short doc ($WORDS words): $file"
            fi
            
            if [ "$WORDS" -gt 3000 ]; then
              echo "üìñ Long doc ($WORDS words): $file - consider splitting"
            fi
          done
          
          echo "‚úÖ Length check complete"

      - name: Check for Code Examples
        run: |
          echo "üíª Checking for code examples in guides..."
          
          find docs/guides -name "*.md" 2>/dev/null | while read file; do
            if ! grep -q '```' "$file"; then
              echo "‚ö†Ô∏è No code examples: $file"
            fi
          done
          
          echo "‚úÖ Code example check complete"

      - name: Check for Prerequisites
        run: |
          echo "üìã Checking for prerequisites sections..."
          
          find docs/guides -name "*.md" 2>/dev/null | while read file; do
            if ! grep -qi "prerequisite\|before you begin\|requirements" "$file"; then
              echo "‚ö†Ô∏è Missing prerequisites: $file"
            fi
          done
          
          echo "‚úÖ Prerequisites check complete"

  # ============================================
  # FRESHNESS CHECK
  # ============================================
  freshness-check:
    name: üìÖ Freshness Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Documentation Freshness
        run: |
          echo "üìÖ Checking documentation freshness..."
          
          STALE_DAYS=90
          WARN_DAYS=60
          NOW=$(date +%s)
          
          STALE_COUNT=0
          WARN_COUNT=0
          
          find docs/ -name "*.md" | while read file; do
            # Get last commit date for file
            LAST_MODIFIED=$(git log -1 --format=%ct -- "$file" 2>/dev/null || echo "$NOW")
            
            DAYS_OLD=$(( (NOW - LAST_MODIFIED) / 86400 ))
            
            if [ "$DAYS_OLD" -gt "$STALE_DAYS" ]; then
              echo "üî¥ Stale ($DAYS_OLD days): $file"
              STALE_COUNT=$((STALE_COUNT + 1))
            elif [ "$DAYS_OLD" -gt "$WARN_DAYS" ]; then
              echo "üü° Aging ($DAYS_OLD days): $file"
              WARN_COUNT=$((WARN_COUNT + 1))
            fi
          done
          
          echo ""
          echo "üìä Freshness Summary"
          echo "  Stale (>$STALE_DAYS days): $STALE_COUNT"
          echo "  Aging (>$WARN_DAYS days): $WARN_COUNT"

  # ============================================
  # SPELL CHECK
  # ============================================
  spell-check:
    name: üìñ Spell Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install cspell
        run: npm install -g cspell

      - name: Create cspell config
        run: |
          cat > cspell.json << 'EOF'
          {
            "version": "0.2",
            "language": "en",
            "words": [
              "docusaurus",
              "frontmatter",
              "prereqs",
              "timestamp",
              "webhook",
              "webhooks",
              "dropdown",
              "checkbox",
              "checkboxes",
              "schemas",
              "linter",
              "linting",
              "uncomment"
            ],
            "ignorePaths": [
              "node_modules/**",
              "*.json",
              "*.yml",
              "*.yaml"
            ]
          }
          EOF

      - name: Run Spell Check
        continue-on-error: true
        run: |
          echo "üìñ Running spell check..."
          cspell "docs/**/*.md" "*.md" || true
          echo "‚úÖ Spell check complete"

  # ============================================
  # THOMAS'S FINAL VERDICT
  # ============================================
  thomas-verdict:
    name: ‚úÖ Thomas's Verdict
    runs-on: ubuntu-latest
    needs: [structure-check, markdown-lint, style-check, link-check, content-quality]
    if: always()
    steps:
      - name: Evaluate Results
        run: |
          echo "üìö Thomas's Documentation Verdict"
          echo "=================================="
          echo ""
          
          ISSUES=0
          
          check_result() {
            local name=$1
            local result=$2
            
            if [ "$result" = "success" ]; then
              echo "‚úÖ $name"
            elif [ "$result" = "skipped" ]; then
              echo "‚è≠Ô∏è $name (skipped)"
            else
              echo "‚ö†Ô∏è $name (needs attention)"
              ISSUES=$((ISSUES + 1))
            fi
          }
          
          check_result "Structure" "${{ needs.structure-check.result }}"
          check_result "Markdown Lint" "${{ needs.markdown-lint.result }}"
          check_result "Style Guide" "${{ needs.style-check.result }}"
          check_result "Links" "${{ needs.link-check.result }}"
          check_result "Content Quality" "${{ needs.content-quality.result }}"
          
          echo ""
          
          if [ "$ISSUES" -eq 0 ]; then
            echo "üìö Thomas says: Documentation looks great!"
          else
            echo "üìù Thomas says: Found $ISSUES area(s) to review."
            echo "   Good documentation takes iteration - keep at it!"
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            
            const structureOk = '${{ needs.structure-check.result }}' === 'success';
            const lintOk = '${{ needs.markdown-lint.result }}' === 'success';
            const styleOk = '${{ needs.style-check.result }}' === 'success';
            const linksOk = '${{ needs.link-check.result }}' === 'success';
            const contentOk = '${{ needs.content-quality.result }}' === 'success';
            
            const allPassed = structureOk && lintOk && styleOk && linksOk && contentOk;
            
            let body;
            if (allPassed) {
              body = `## üìö Thomas's Documentation Review: ‚úÖ Approved!
            
            Great documentation work! All checks passed:
            
            | Check | Status |
            |-------|--------|
            | Structure | ‚úÖ |
            | Markdown Lint | ‚úÖ |
            | Style Guide | ‚úÖ |
            | Links | ‚úÖ |
            | Content Quality | ‚úÖ |
            
            Clear documentation helps everyone succeed! üéâ`;
            } else {
              body = `## üìö Thomas's Documentation Review: üìù Improvements Suggested
            
            | Check | Status |
            |-------|--------|
            | Structure | ${structureOk ? '‚úÖ' : '‚ö†Ô∏è'} |
            | Markdown Lint | ${lintOk ? '‚úÖ' : '‚ö†Ô∏è'} |
            | Style Guide | ${styleOk ? '‚úÖ' : '‚ö†Ô∏è'} |
            | Links | ${linksOk ? '‚úÖ' : '‚ö†Ô∏è'} |
            | Content Quality | ${contentOk ? '‚úÖ' : '‚ö†Ô∏è'} |
            
            Check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.
            
            Remember: Good documentation is iterative. Happy to help! üìö`;
            }
            
            // Find existing Thomas comment
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
            });
            
            const thomasComment = comments.data.find(
              c => c.body.includes("Thomas's Documentation Review")
            );
            
            if (thomasComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: thomasComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body,
              });
            }
