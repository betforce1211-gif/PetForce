-- =============================================================================
-- Buck's dbt Fact Model Template
-- Bad data is worse than no data. Good pipelines make good data.
-- =============================================================================
--
-- Fact models are the GOLD layer:
-- • Business-ready data
-- • Contains measures (quantities, amounts)
-- • References dimension tables
-- • Often incremental for large tables
--
-- Naming: fct_<business_process>
-- Example: fct_orders, fct_payments, fct_sessions
-- =============================================================================

{{
  config(
    materialized='incremental',
    unique_key='{{TABLE_NAME}}_key',
    schema='marts',
    
    -- Partitioning (Snowflake)
    -- partition_by=['DATE(created_at)'],
    
    -- Partitioning (BigQuery)
    partition_by={
      "field": "created_at",
      "data_type": "timestamp",
      "granularity": "day"
    },
    
    -- Clustering for query performance
    cluster_by=['customer_id', 'created_at'],
    
    -- Incremental strategy
    incremental_strategy='merge',
    
    -- Tags for selective runs
    tags=['daily', 'core']
  )
}}

-- =============================================================================
-- IMPORT CTEs (referenced models)
-- =============================================================================

with staging_data as (
    select * from {{ ref('stg_{{SOURCE_NAME}}__{{TABLE_NAME}}') }}
    
    {% if is_incremental() %}
    -- Only process new/updated records
    where updated_at > (select max(updated_at) from {{ this }})
    {% endif %}
),

-- Reference dimension tables
dim_customers as (
    select * from {{ ref('dim_customers') }}
),

dim_products as (
    select * from {{ ref('dim_products') }}
),

dim_date as (
    select * from {{ ref('dim_date') }}
),

-- =============================================================================
-- LOGICAL CTEs (business logic)
-- =============================================================================

enriched as (
    select
        s.*,
        
        -- Add dimension attributes
        c.customer_segment,
        c.customer_tier,
        p.product_category,
        p.product_line,
        
        -- Date dimension keys
        d.date_key,
        d.fiscal_year,
        d.fiscal_quarter
        
    from staging_data s
    left join dim_customers c on s.customer_id = c.customer_id
    left join dim_products p on s.product_id = p.product_id
    left join dim_date d on date(s.created_at) = d.date_day
),

-- =============================================================================
-- CALCULATED FIELDS
-- =============================================================================

calculated as (
    select
        *,
        
        -- Calculate derived measures
        quantity * unit_price as gross_amount,
        quantity * unit_price * (1 - discount_rate) as net_amount,
        quantity * unit_cost as total_cost,
        (quantity * unit_price * (1 - discount_rate)) - (quantity * unit_cost) as profit,
        
        -- Calculate tiers/buckets
        case
            when quantity * unit_price >= 1000 then 'high_value'
            when quantity * unit_price >= 100 then 'medium_value'
            else 'low_value'
        end as order_tier,
        
        -- Time-based calculations
        datediff('day', customer_first_order_at, created_at) as days_since_first_order
        
    from enriched
),

-- =============================================================================
-- FINAL SELECT
-- =============================================================================

final as (
    select
        -- =================================================================
        -- SURROGATE KEY
        -- =================================================================
        {{ dbt_utils.generate_surrogate_key(['{{TABLE_NAME}}_id']) }} as {{TABLE_NAME}}_key,
        
        -- =================================================================
        -- NATURAL KEY
        -- =================================================================
        {{TABLE_NAME}}_id,
        
        -- =================================================================
        -- FOREIGN KEYS (for joining to dimensions)
        -- =================================================================
        customer_id,
        {{ dbt_utils.generate_surrogate_key(['customer_id']) }} as customer_key,
        product_id,
        {{ dbt_utils.generate_surrogate_key(['product_id']) }} as product_key,
        date_key,
        
        -- =================================================================
        -- DIMENSION ATTRIBUTES (denormalized for performance)
        -- =================================================================
        customer_segment,
        customer_tier,
        product_category,
        product_line,
        
        -- =================================================================
        -- DEGENERATE DIMENSIONS (from the fact)
        -- =================================================================
        status,
        order_tier,
        
        -- =================================================================
        -- MEASURES (additive facts)
        -- =================================================================
        quantity,
        unit_price,
        discount_rate,
        gross_amount,
        net_amount,
        total_cost,
        profit,
        
        -- =================================================================
        -- TIMESTAMPS
        -- =================================================================
        created_at,
        updated_at,
        
        -- =================================================================
        -- METADATA
        -- =================================================================
        current_timestamp() as dbt_updated_at,
        '{{ invocation_id }}' as dbt_invocation_id
        
    from calculated
)

select * from final

-- =============================================================================
-- SCHEMA FILE (_models.yml)
-- =============================================================================
-- 
-- version: 2
-- 
-- models:
--   - name: fct_{{TABLE_NAME}}
--     description: "Fact table for {{TABLE_NAME}}"
--     
--     columns:
--       - name: {{TABLE_NAME}}_key
--         description: "Surrogate key"
--         tests:
--           - unique
--           - not_null
--           
--       - name: {{TABLE_NAME}}_id
--         description: "Natural key from source"
--         tests:
--           - unique
--           - not_null
--           
--       - name: customer_id
--         description: "Foreign key to customer"
--         tests:
--           - not_null
--           - relationships:
--               to: ref('dim_customers')
--               field: customer_id
--               
--       - name: net_amount
--         description: "Net transaction amount after discounts"
--         tests:
--           - not_null
--           - dbt_utils.accepted_range:
--               min_value: 0
--               
--     tests:
--       - dbt_utils.expression_is_true:
--           expression: "net_amount = gross_amount * (1 - discount_rate)"
-- 
-- =============================================================================
