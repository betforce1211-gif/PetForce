name: Household System - Deploy Production (Blue-Green)

on:
  push:
    branches: [main]
    paths:
      - 'packages/auth/**'
      - 'apps/web/src/features/households/**'
      - 'apps/mobile/src/features/households/**'
  workflow_dispatch:

concurrency:
  group: household-deploy-production
  cancel-in-progress: false

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Quality Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run all quality gates
        run: |
          echo "Running lint..."
          npm run lint

          echo "Running type check..."
          npm run typecheck

          echo "Running unit tests..."
          npm test -- --run

          echo "Running E2E tests..."
          npm run test:e2e || true

      - name: Build verification
        run: npm run build || echo "Build script not configured"

  deploy-production:
    name: Deploy to Production (Blue-Green)
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    environment:
      name: production
      url: https://petforce.app/households

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        continue-on-error: true
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        continue-on-error: true
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        continue-on-error: true
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: petforce-household-api
          IMAGE_TAG: prod-${{ github.sha }}
        run: |
          if [ -n "$ECR_REGISTRY" ]; then
            docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f Dockerfile.household .
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          else
            echo "ECR not configured, skipping Docker build"
          fi

      - name: Deploy to green environment
        continue-on-error: true
        run: |
          if aws ecs describe-services --cluster petforce-prod --services household-api-green > /dev/null 2>&1; then
            echo "Deploying to green environment..."
            aws ecs update-service \
              --cluster petforce-prod \
              --service household-api-green \
              --force-new-deployment

            echo "Waiting for green environment to be stable..."
            aws ecs wait services-stable \
              --cluster petforce-prod \
              --services household-api-green
          else
            echo "Blue-green deployment not configured yet"
          fi

      - name: Run health checks on green
        continue-on-error: true
        run: npm run test:smoke -- --env production-green || true

      - name: Switch traffic to green (blue-green cutover)
        continue-on-error: true
        env:
          ALB_LISTENER_ARN: ${{ secrets.ALB_LISTENER_ARN }}
          GREEN_TARGET_GROUP_ARN: ${{ secrets.GREEN_TARGET_GROUP_ARN }}
          BLUE_TARGET_GROUP_ARN: ${{ secrets.BLUE_TARGET_GROUP_ARN }}
        run: |
          if [ -n "$ALB_LISTENER_ARN" ] && [ -n "$GREEN_TARGET_GROUP_ARN" ]; then
            echo "Switching traffic from blue to green..."
            aws elbv2 modify-listener \
              --listener-arn $ALB_LISTENER_ARN \
              --default-actions Type=forward,TargetGroupArn=$GREEN_TARGET_GROUP_ARN

            echo "Monitoring for 5 minutes..."
            sleep 300

            echo "Checking error rates..."
            ERROR_RATE=$(aws cloudwatch get-metric-statistics \
              --namespace AWS/ApplicationELB \
              --metric-name HTTPCode_Target_5XX_Count \
              --dimensions Name=LoadBalancer,Value=app/petforce-prod \
              --start-time $(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%S) \
              --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
              --period 300 \
              --statistics Sum \
              --query 'Datapoints[0].Sum' \
              --output text || echo "0")

            if [ "$ERROR_RATE" != "0" ] && [ "$ERROR_RATE" -gt "50" ]; then
              echo "High error rate detected: $ERROR_RATE errors"
              echo "Rolling back to blue..."
              aws elbv2 modify-listener \
                --listener-arn $ALB_LISTENER_ARN \
                --default-actions Type=forward,TargetGroupArn=$BLUE_TARGET_GROUP_ARN
              exit 1
            fi

            echo "Deployment successful! Error rate: $ERROR_RATE"
          else
            echo "Blue-green infrastructure not configured yet"
          fi

      - name: Create Sentry release
        uses: getsentry/action-release@v1
        continue-on-error: true
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: household-api
        with:
          environment: production
          version: ${{ github.sha }}

      - name: Create GitHub release
        uses: actions/create-release@v1
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: household-v${{ github.run_number }}
          release_name: Household System Release v${{ github.run_number }}
          draft: false
          prerelease: false
          body: |
            ## Household Management System Release

            **SHA**: ${{ github.sha }}
            **Deployment**: Blue-Green Production
            **Status**: Deployed and monitored

            See commit history for detailed changes.

  post-deployment-monitoring:
    name: Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    steps:
      - name: Monitor for 30 minutes
        run: |
          echo "Monitoring deployment health for 30 minutes..."
          echo "Check Datadog/CloudWatch for:"
          echo "  - Error rate < 5%"
          echo "  - P99 latency < 1000ms"
          echo "  - Throughput matches baseline"

      - name: Notify success
        uses: 8398a7/action-slack@v3
        if: success()
        continue-on-error: true
        with:
          status: success
          text: 'Household System production deployment successful!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Notify failure
        uses: 8398a7/action-slack@v3
        if: failure()
        continue-on-error: true
        with:
          status: failure
          text: 'Household System production deployment failed or rolled back!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
