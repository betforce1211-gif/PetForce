# CI/CD Issue Sync
# Creates and updates GitHub Issues from CI/CD events
# Chuck's Quality Gate: All failures tracked, all fixes verified

name: CI Issue Sync

on:
  workflow_run:
    workflows: ["CI", "E2E Tests", "Security Scan"]
    types: [completed]

permissions:
  issues: write
  contents: read
  actions: read

jobs:
  create-issue-on-failure:
    name: Create Issue on CI Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create or update failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = context.payload.workflow_run.name;
            const runUrl = context.payload.workflow_run.html_url;
            const branch = context.payload.workflow_run.head_branch;
            const commit = context.payload.workflow_run.head_sha.substring(0, 7);
            const actor = context.payload.workflow_run.actor.login;
            
            // Search for existing open issue
            const searchQuery = `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open label:ci-failure "${workflowName} Failure"`;
            const { data: existingIssues } = await github.rest.search.issuesAndPullRequests({
              q: searchQuery
            });
            
            const issueBody = `## CI Failure Alert\n\n` +
              `**Workflow**: ${workflowName}\n` +
              `**Branch**: \`${branch}\`\n` +
              `**Commit**: \`${commit}\`\n` +
              `**Triggered by**: @${actor}\n` +
              `**Run**: ${runUrl}\n\n` +
              `### Details\n\n` +
              `The ${workflowName} workflow failed. This may indicate:\n` +
              `- Test failures\n` +
              `- Build errors\n` +
              `- Security vulnerabilities\n` +
              `- Deployment issues\n\n` +
              `### Action Required\n\n` +
              `1. Review the workflow logs: ${runUrl}\n` +
              `2. Fix the failing tests/checks\n` +
              `3. Push the fix\n` +
              `4. Verify the workflow passes\n\n` +
              `**Quality gates protect pet families** - this must be fixed before merging.\n\n` +
              `---\n` +
              `*Last failed: ${new Date().toISOString()}*`;
            
            if (existingIssues.total_count > 0) {
              // Update existing issue
              const issue = existingIssues.items[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `⚠️ **Workflow failed again**\n\n${issueBody}`
              });
              console.log(`Updated existing issue #${issue.number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[CI] ${workflowName} Failure on ${branch}`,
                body: issueBody,
                labels: ['ci-failure', 'bug', 'agent:chuck', 'priority:high']
              });
              console.log(`Created new issue #${newIssue.number}`);
            }

  close-issue-on-success:
    name: Close Issue on CI Success
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Close failure issue if exists
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = context.payload.workflow_run.name;
            const branch = context.payload.workflow_run.head_branch;
            
            // Search for open CI failure issues for this workflow
            const searchQuery = `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open label:ci-failure "${workflowName} Failure"`;
            const { data: openIssues } = await github.rest.search.issuesAndPullRequests({
              q: searchQuery
            });
            
            for (const issue of openIssues.items) {
              if (issue.title.includes(branch) || issue.body.includes(branch)) {
                // Close the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                
                // Add success comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `✅ **Workflow passed!**\n\nThe ${workflowName} workflow is now passing on \`${branch}\`.\n\nClosing this issue.`
                });
                
                console.log(`Closed issue #${issue.number}`);
              }
            }

  security-vulnerability-issue:
    name: Create Security Issue
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.name == 'Security Scan' && github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Create security vulnerability issue
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = context.payload.workflow_run.html_url;
            const commit = context.payload.workflow_run.head_sha.substring(0, 7);
            
            const issueBody = `## Security Vulnerability Detected\n\n` +
              `**Commit**: \`${commit}\`\n` +
              `**Scan Results**: ${runUrl}\n\n` +
              `### Action Required\n\n` +
              `A security vulnerability was detected during the automated security scan.\n\n` +
              `**Immediate Actions:**\n` +
              `1. Review the scan results immediately\n` +
              `2. Assess the severity (Critical/High/Medium/Low)\n` +
              `3. Create a fix or mitigation plan\n` +
              `4. Update dependencies if needed\n` +
              `5. Re-run security scan to verify fix\n\n` +
              `**Security is non-negotiable** - pet families trust us with their data.\n\n` +
              `cc: @samantha (Security Agent)`;
            
            const { data: newIssue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[SECURITY] Vulnerability detected in ${commit}`,
              body: issueBody,
              labels: ['security', 'vulnerability', 'agent:samantha', 'priority:critical']
            });
            
            console.log(`Created security issue #${newIssue.number}`);
