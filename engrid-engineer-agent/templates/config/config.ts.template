// =============================================================================
// Configuration Module Template
// Generated by Engrid - Build it once, build it right, build it to last
// =============================================================================
// 
// This module provides a type-safe, hierarchical configuration system
// with support for multiple sources (env vars, files, runtime overrides)
// =============================================================================

import { z } from 'zod';
import { deepMerge } from '@/shared/utils';

// =============================================================================
// CONFIGURATION SCHEMA
// =============================================================================

/**
 * Define your configuration schema here.
 * This provides type safety AND runtime validation.
 */
const ConfigSchema = z.object({
  // ---------------------------------------------------------------------------
  // Environment
  // ---------------------------------------------------------------------------
  env: z.enum(['development', 'test', 'staging', 'production']).default('development'),
  debug: z.boolean().default(false),
  
  // ---------------------------------------------------------------------------
  // Server
  // ---------------------------------------------------------------------------
  server: z.object({
    host: z.string().default('0.0.0.0'),
    port: z.number().int().positive().default(3000),
    corsOrigins: z.array(z.string()).default(['http://localhost:3000']),
  }),
  
  // ---------------------------------------------------------------------------
  // API
  // ---------------------------------------------------------------------------
  api: z.object({
    baseUrl: z.string().url(),
    version: z.string().default('v1'),
    timeoutMs: z.number().int().positive().default(30000),
    maxRetries: z.number().int().min(0).default(3),
    retryDelayMs: z.number().int().min(0).default(1000),
    
    pagination: z.object({
      defaultPageSize: z.number().int().positive().default(20),
      maxPageSize: z.number().int().positive().default(100),
    }),
    
    rateLimit: z.object({
      enabled: z.boolean().default(true),
      requestsPerMinute: z.number().int().positive().default(100),
      burstLimit: z.number().int().positive().default(20),
    }),
    
    cache: z.object({
      enabled: z.boolean().default(true),
      ttlSeconds: z.number().int().min(0).default(60),
    }),
  }),
  
  // ---------------------------------------------------------------------------
  // Database
  // ---------------------------------------------------------------------------
  database: z.object({
    url: z.string(),
    maxConnections: z.number().int().positive().default(10),
    minConnections: z.number().int().min(0).default(2),
    idleTimeoutMs: z.number().int().positive().default(30000),
    connectionTimeoutMs: z.number().int().positive().default(2000),
  }),
  
  // ---------------------------------------------------------------------------
  // Cache (Redis)
  // ---------------------------------------------------------------------------
  cache: z.object({
    enabled: z.boolean().default(true),
    url: z.string().optional(),
    keyPrefix: z.string().default('app:'),
    defaultTTLSeconds: z.number().int().min(0).default(300),
  }),
  
  // ---------------------------------------------------------------------------
  // Authentication
  // ---------------------------------------------------------------------------
  auth: z.object({
    secretKey: z.string().min(32),
    accessTokenExpirySeconds: z.number().int().positive().default(900), // 15 min
    refreshTokenExpiryDays: z.number().int().positive().default(7),
    maxLoginAttempts: z.number().int().positive().default(5),
    lockoutMinutes: z.number().int().positive().default(15),
    
    mfa: z.object({
      enabled: z.boolean().default(false),
      issuer: z.string().default('MyApp'),
    }),
  }),
  
  // ---------------------------------------------------------------------------
  // Features (Feature Flags)
  // ---------------------------------------------------------------------------
  features: z.object({
    enableNewDashboard: z.boolean().default(false),
    enableBetaFeatures: z.boolean().default(false),
    enableAnalytics: z.boolean().default(true),
    // Add your feature flags here
  }),
  
  // ---------------------------------------------------------------------------
  // Platform-Specific
  // ---------------------------------------------------------------------------
  platform: z.object({
    web: z.object({
      enablePWA: z.boolean().default(true),
      cacheStrategy: z.enum(['network-first', 'cache-first', 'stale-while-revalidate']).default('network-first'),
    }),
    
    mobile: z.object({
      enableOfflineMode: z.boolean().default(true),
      syncIntervalMs: z.number().int().positive().default(30000),
      enablePushNotifications: z.boolean().default(true),
    }),
    
    desktop: z.object({
      enableAutoUpdate: z.boolean().default(true),
      updateCheckIntervalMs: z.number().int().positive().default(3600000),
    }),
  }),
  
  // ---------------------------------------------------------------------------
  // UI / UX
  // ---------------------------------------------------------------------------
  ui: z.object({
    animationDurationMs: z.number().int().min(0).default(200),
    toastDurationMs: z.number().int().positive().default(3000),
    debounceMs: z.number().int().min(0).default(300),
    itemsPerPage: z.number().int().positive().default(20),
  }),
  
  // ---------------------------------------------------------------------------
  // Logging
  // ---------------------------------------------------------------------------
  logging: z.object({
    level: z.enum(['debug', 'info', 'warn', 'error']).default('info'),
    format: z.enum(['json', 'pretty']).default('json'),
    includeTimestamp: z.boolean().default(true),
    includeRequestId: z.boolean().default(true),
  }),
  
  // ---------------------------------------------------------------------------
  // External Services
  // ---------------------------------------------------------------------------
  services: z.object({
    analytics: z.object({
      enabled: z.boolean().default(true),
      provider: z.string().default('mixpanel'),
      apiKey: z.string().optional(),
      sampleRate: z.number().min(0).max(1).default(1),
    }),
    
    email: z.object({
      provider: z.string().default('sendgrid'),
      apiKey: z.string().optional(),
      fromAddress: z.string().email().optional(),
    }),
    
    storage: z.object({
      provider: z.string().default('s3'),
      bucket: z.string().optional(),
      region: z.string().default('us-east-1'),
    }),
  }),
});

// Infer the TypeScript type from the schema
export type AppConfig = z.infer<typeof ConfigSchema>;

// =============================================================================
// DEFAULT CONFIGURATION
// =============================================================================

const defaultConfig: Partial<AppConfig> = {
  env: 'development',
  debug: false,
  server: {
    host: '0.0.0.0',
    port: 3000,
    corsOrigins: ['http://localhost:3000'],
  },
  // ... other defaults are defined in the schema
};

// =============================================================================
// CONFIGURATION MANAGER
// =============================================================================

class ConfigManager {
  private config: AppConfig;
  private listeners: Set<(config: AppConfig) => void> = new Set();

  constructor() {
    this.config = this.loadConfig();
    this.validateConfig();
  }

  /**
   * Load configuration from all sources (in priority order)
   */
  private loadConfig(): AppConfig {
    const envConfig = this.loadFromEnvironment();
    const fileConfig = this.loadFromFile();
    
    const merged = deepMerge(
      defaultConfig,
      fileConfig,
      envConfig,
    );
    
    return ConfigSchema.parse(merged);
  }

  /**
   * Load configuration from environment variables
   */
  private loadFromEnvironment(): Partial<AppConfig> {
    const env = process.env;
    
    return {
      env: env.NODE_ENV as AppConfig['env'],
      debug: env.DEBUG === 'true',
      server: {
        host: env.HOST,
        port: env.PORT ? parseInt(env.PORT, 10) : undefined,
        corsOrigins: env.CORS_ORIGINS?.split(','),
      },
      api: {
        baseUrl: env.API_BASE_URL,
      },
      database: {
        url: env.DATABASE_URL,
      },
      cache: {
        url: env.REDIS_URL,
      },
      auth: {
        secretKey: env.AUTH_SECRET_KEY,
      },
      // Add more environment variable mappings as needed
    };
  }

  /**
   * Load configuration from file (config/{env}.json or config/{env}.ts)
   */
  private loadFromFile(): Partial<AppConfig> {
    const env = process.env.NODE_ENV || 'development';
    
    try {
      // Try to load environment-specific config
      // eslint-disable-next-line @typescript-eslint/no-var-requires
      return require(`./environments/${env}`).default;
    } catch {
      return {};
    }
  }

  /**
   * Validate the configuration
   */
  private validateConfig(): void {
    // Additional custom validation beyond schema
    const { config } = this;
    
    if (config.env === 'production') {
      if (!config.auth.secretKey || config.auth.secretKey.length < 32) {
        throw new Error('Production requires a secure auth secret key');
      }
      
      if (config.debug) {
        console.warn('Warning: Debug mode is enabled in production');
      }
    }
  }

  /**
   * Get a configuration value by path
   * 
   * @example
   * ```typescript
   * const timeout = config.get('api.timeoutMs');
   * const pageSize = config.get('api.pagination.defaultPageSize', 20);
   * ```
   */
  get<T = unknown>(path: string, defaultValue?: T): T {
    const keys = path.split('.');
    let value: unknown = this.config;
    
    for (const key of keys) {
      if (value === null || value === undefined) {
        return defaultValue as T;
      }
      value = (value as Record<string, unknown>)[key];
    }
    
    return (value ?? defaultValue) as T;
  }

  /**
   * Get a typed configuration section
   * 
   * @example
   * ```typescript
   * const apiConfig = config.getSection('api');
   * ```
   */
  getSection<K extends keyof AppConfig>(key: K): AppConfig[K] {
    return this.config[key];
  }

  /**
   * Get the entire configuration object
   */
  getAll(): Readonly<AppConfig> {
    return Object.freeze({ ...this.config });
  }

  /**
   * Check if a feature is enabled
   * 
   * @example
   * ```typescript
   * if (config.isFeatureEnabled('enableNewDashboard')) {
   *   // Show new dashboard
   * }
   * ```
   */
  isFeatureEnabled(feature: keyof AppConfig['features']): boolean {
    return this.config.features[feature] ?? false;
  }

  /**
   * Override configuration at runtime (e.g., from admin panel)
   * Note: This is meant for development/debugging, not production use
   */
  override(overrides: Partial<AppConfig>): void {
    this.config = ConfigSchema.parse(deepMerge(this.config, overrides));
    this.notifyListeners();
  }

  /**
   * Subscribe to configuration changes
   */
  onChange(listener: (config: AppConfig) => void): () => void {
    this.listeners.add(listener);
    return () => this.listeners.delete(listener);
  }

  private notifyListeners(): void {
    for (const listener of this.listeners) {
      listener(this.config);
    }
  }

  /**
   * Reload configuration from all sources
   */
  reload(): void {
    this.config = this.loadConfig();
    this.validateConfig();
    this.notifyListeners();
  }
}

// =============================================================================
// SINGLETON EXPORT
// =============================================================================

export const config = new ConfigManager();

// =============================================================================
// TYPE EXPORTS
// =============================================================================

export type { AppConfig };
export { ConfigSchema };
